---
title: "nflrushing animate"
output: html_document
date: '2022-06-23'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(nflfastR)
library(nflreadr)
library(tidyverse)
library(gganimate)
library(nflplotR)
library(ggimage)
library(glue)

options(scipen = 999)

```

load season stats and filter

```{r}
season2021 <- load_player_stats(2021)
season2021 %>% view()
top_rush <- season2021 %>% 
  group_by(player_id) %>% 
    filter(season_type == "REG", sum(rushing_yards) > 936) %>% 
  ungroup()

top_rush <- top_rush %>% 
  group_by(player_name) %>% 
  mutate(cumulative_rush = cumsum(rushing_yards)) %>% 
  ungroup()

top_rush <- top_rush %>% 
  select(player_id, player_name, recent_team, week, carries, rushing_yards, rushing_tds, rushing_fumbles, rushing_epa, rushing_first_downs, fantasy_points_ppr, cumulative_rush )

top_rush$game <- seq_along(top_rush$player_name)

top_rush %>% count(player_name)
top_rush <- top_rush %>% 
  rename(team_abbr = recent_team)

top_rush <- top_rush %>% 
  left_join(teams_colors_logos, by = c("team_abbr" = "team_abbr"))

```

now for graphs

```{r}

top_rush %>% 
  ggplot(aes(cumulative_rush, player_name, color = player_name)) +
  geom_col() + 
  transition_time(week)

top_rush %>% 
  ggplot(aes(week, cumulative_rush, group = player_name)) +
  geom_line() +
  geom_point() +
  transition_reveal(week)


top_rush %>% 
  ggplot(aes(week, cumulative_rush, group = player_name)) + 
  geom_image(aes(image = team_logo_espn), width = 0.03, alpha = 0.7)

animation <- top_rush %>%
  filter(player_name == "J.Taylor") %>% 
  ggplot(aes(week, cumulative_rush, group = player_name)) +
  geom_line() +
  geom_image(aes(image = team_logo_espn), size = .05) +
  transition_reveal(week) +
  ggtitle('Rushing Total by Week')

animate(animation, end_pause = 10)

```

Just D.Henry

```{r}
dhenry <- load_player_stats(2016:2021) %>% filter(player_name == "D.Henry")

dhenry <- dhenry %>% filter(season_type == "REG")

dhenry <- dhenry %>% 
  select(player_name, recent_team, rushing_yards, rushing_epa, rushing_first_downs, season, week)

dhenry <- dhenry %>% 
  group_by(season) %>% 
  mutate(cumrush = cumsum(rushing_yards)) %>% 
  ungroup()

dhenry <- dhenry %>%
  left_join(teams_colors_logos, by = c("recent_team" = "team_abbr"))

dh <- dhenry %>% 
  ggplot(aes(week, cumrush, group = season, label = season, color = season)) +
  labs(x = "Week", 
       y = "Season Total Rushing Yards",
       title = "Derrick Henry Rushing Yards by Season",
       subtitle = "What could have happened in 2021?",
       caption = "@jmeerse  Data: nflfastR") +
  scale_x_continuous(breaks = seq(1, 17),
                     limits = c(1, 18)) +
  geom_line(size = 1) + 
  geom_text(size = 5) +
  theme_classic()

dh

animate(dh + transition_reveal(dhenry$week), end_pause = 30, width=900, height=506)


anim_save("DHenry.gif")

```

Now let's compare QBs

```{r}
pmja <- load_player_stats(2017:2021) %>% filter(player_name == "P.Mahomes" | player_name == "J.Allen" & recent_team == "BUF")

pmja <- pmja %>% filter(season_type == "REG")

#try to number by games played
pmja <- pmja %>% 
  arrange(player_name) #groups players

length(pmja$player_name)

pmja %>% group_by(player_name) %>% summarise(n = n())

pmja$game_no <- sequence(c(57, 63))

pmja <- pmja %>% 
  group_by(player_name) %>% 
  mutate(cum_epa = cumsum(passing_epa)) %>% 
  ungroup()

pmja <- pmja %>% 
  left_join(teams_colors_logos, by = c("recent_team" = "team_abbr"))

maxqbs <- pmja %>% group_by(player_name) %>% 
  summarise(maxgame = max(game_no), maxepa = max(cum_epa)) %>% 
  ungroup() #df of just maxes, maybe could use for image locations?

pmja %>%  
  ggplot(aes(x = game_no, y = cum_epa, group = player_name)) +
  geom_line() +
  geom_image(data = filter(pmja, player_name == "J.Allen"),aes(x = max(game_no), y = max(cum_epa), image = team_logo_espn), size = 0.08) +
  geom_image(data = filter(pmja, player_name == "P.Mahomes"),aes(x = max(game_no), y = max(cum_epa), image = team_logo_espn), size = 0.08)
```  

help!?!
```{r}
#example for stack.overflow question
name <- c("a", "a", "b", "b", "b") 
game <- c(1, 2, 1, 2, 3) 
pts <- c(3, 6, 1, 6, 7) 
cum_pts <- c(3, 9, 1, 7, 14) 

pics <- c("https://a.espncdn.com/i/teamlogos/nfl/500/buf.png", "https://a.espncdn.com/i/teamlogos/nfl/500/buf.png", "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png", "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png", "https://a.espncdn.com/i/teamlogos/nfl/500/kc.png")

df <- data.frame(name, game, pts, cum_pts, pics)

df %>%  
  ggplot(aes(x = game, y = cum_pts, group = name)) +
  geom_line() +
  geom_image(data = filter(df, name == "a"),aes(x = max(game), y = max(cum_pts), image = pics), size = 0.08) +
  geom_image(data = filter(df, name == "b"),aes(x = max(game), y = max(cum_pts), image = pics), size = 0.08)




```

